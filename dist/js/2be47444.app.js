function randomIntFromInterval(a,b){return Math.floor(Math.random()*(b-a+1)+a)}function isInArray(a,b){return b.indexOf(a)>-1}function getArrayPos(a,b){return b.indexOf(a)}function numberWithCommas(a){return a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function formatBlank(a){return a.replace(/[^\w ]+/g,"").replace(/ +/g,"-")}function init(){$("#loading").css({opacity:0,"margin-top":"20px"}).delay(800).hide(0),$("#container .legend").css(1025>width_mobile?{opacity:1,"margin-left":"13px"}:{opacity:1,"margin-left":"18px"}),$("#container .author").css(1025>width_mobile?{opacity:1}:{opacity:1}),$("#container #circle").css({opacity:1,"margin-top":"0px"}),$("#container #nodes").css({opacity:1,"margin-top":"0px"}),$("#container #lines_current").css({opacity:1,"margin-top":"0px"}),$("#container #lines_current_selected").css({opacity:1,"margin-top":"0px"}),$("#container #lines_history").css({opacity:1,"margin-top":"0px"}),$("#container #sidebar").css({opacity:1,top:"25px"}).delay(6e3).queue(function(){$(this).addClass("nodelay")}),$(".head h1").removeClass("loadType"),$(".head h2").removeClass("loadType"),$(".head h2 .more").removeClass("loadType"),data.forEach(function(a,b){years.push({pos:b,val:a.year}),c=a.year,data_prepared.push(prepare_data(data[b].data))});var a=location.hash.replace("#",""),b=a.split("_");if(4!=b[0].length||isNaN(b[0])?current=years[years.length-1]:$.each(years,function(a,c){c.val==b[0]&&(current=years[c.pos])}),nodes=data_prepared[current.pos][0],links=data_prepared[current.pos][1],createSelectBox(nodes_.children),draw(),$("#slider").attr("max",years.length-1).val(current.pos),user_interaction_init=!1,"undefined"!=typeof b[1]){if(2==b[1].length)var d=500+getArrayPos(b[1],select_list_arr_cont);else var d=getArrayPos(b[1],select_list_arr);isNaN(d)||($("#e1").select2("val",d,!0),location.hash=current.val+"_"+b[1])}user_interaction_init_time=(new Date).getTime(),0==user_interaction_init&&initAnime(),ga("send","event","page_load","page_load")}function prepare_data(a){return nodes_=packageHierarchy(a),nodes_sorted=[],nodes_.children.forEach(function(a){a.children.sort(function(a,b){return d3.ascending(a.name,b.name)}),"EU"==a.name?nodes_sorted[0]=a:"AS"==a.name?nodes_sorted[1]=a:"OC"==a.name?nodes_sorted[2]=a:"AF"==a.name?nodes_sorted[3]=a:"SA"==a.name?nodes_sorted[4]=a:"NA"==a.name&&(nodes_sorted[5]=a)}),nodes_.children=nodes_sorted,nodes__=cluster.nodes(nodes_),links__=packageImports(nodes__),[nodes__,links__]}function packageHierarchy(a){function b(a,d){var e,f=c[a];return f||(f=c[a]=d||{name:a,children:[]},a.length&&(f.parent=b(a.substring(0,e=a.lastIndexOf("."))),f.parent.children.push(f),f.key=a.substring(e+1))),f}var c={};return a.forEach(function(a){b(a.name,a)}),c[""]}function packageImports(a){var b={},c=[];return a.forEach(function(a){b[a.name]=a}),a.forEach(function(a){a.imports&&a.imports.forEach(function(d){d.imports&&d.imports.forEach(function(e){var f=jQuery.extend({},b[e]);f.id=d.id,f.depth_=d.depth,c.push({source:b[a.name],target:f})});var e=b[a.name];if(e.id){var f=-1;e.id.forEach(function(a,b){a==d.id&&(f=b)}),-1==f&&e.id.push(d.id)}else e.id=[d.id]})}),c}function draw(){svg_circle.append("circle").classed("circleBG",!0).attr("r",radius-radius/26),node=svg.append("g").classed("nodes",!0).selectAll(".node").data(nodes.filter(function(a){return!a.children}));var node_enter=node.enter().append("g").attr("class",function(a){return"node "+formatBlank(a.name)}).each(function(a){var b=-1;countries.forEach(function(c,d){c.name==a.key&&(b=d)}),-1!=b?countries[b].ftas=a.ta_total:countries.push({name:a.key,ftas:a.ta_total})}).attr("transform",function(a){return"rotate("+(a.x-90)+") translate("+(a.y+8)+",0)"}).on("mouseover",function(a){nodeHover=!0,0==selectItem&&($(this).attr("class").indexOf("show")<0&&resetSelection(),mouseoveredNode(a,"hover"))}).on("mouseout",function(){nodeHover=!1,setTimeout(function(){0==selectItem&&0==nodeHover&&resetSelection()},25)}).on("click",function(a){mouseClickNode(a)});node_enter.append("circle").classed("circleCountry",!0).attr("fill","#fff").attr("r",0).attr("cx","-.70em"),node_enter.append("text").classed("labelBg",!0).attr("transform",function(a){return a.x<180?"":"rotate(180)"}).style("text-anchor",function(a){return a.x<180?"start":"end"}).attr("dy",".31em").text(function(a){return a.key.toUpperCase()}),node_enter.append("text").classed("label",!0).attr("transform",function(a){return a.x<180?"":"rotate(180)"}).style("text-anchor",function(a){return a.x<180?"start":"end"}).attr("dy",".31em").text(function(a){return a.key.toUpperCase()});for(var cont=svg.append("g").classed("continents",!0),i=0;i<continent.length-1;i++){var center_text="0%";"AF"==continent[i].key&&(center_text="75%"),"AS"==continent[i].key&&(center_text="78%"),"EU"==continent[i].key&&(center_text="28%"),"NA"==continent[i].key&&(center_text="33%"),"SA"==continent[i].key&&(center_text="42%"),"OC"==continent[i].key&&(center_text="69%");var cont_=cont.append("g").attr("class","continent_"+continent[i].key+" continent").on("mouseover",function(){nodeHover=!0;var a=$(this).attr("class");a=a.split(/[ ]+/);var b=a[0].substring(a[0].length-2,a[0].length);0==selectItem&&($(this).attr("class").indexOf("node--active")<0&&resetSelection(),mouseoveredContinent(b,"hover"))}).on("mouseout",function(){nodeHover=!1,setTimeout(function(){0==selectItem&&0==nodeHover&&resetSelection()},25)}).on("click",function(){var a=$(this).attr("class");a=a.split(/[ ]+/);var b=a[0].substring(a[0].length-2,a[0].length);mouseClickContinent(b)}),path=cont_.append("path").attr("id","path"+continent[i].key).attr("class","pathContinent").attr("d",eval("arc_"+continent[i].key+"()"));path=path.node(),cont_.append("text").attr("x",0).attr("y",0).attr("dy",function(){var a=ms_ie?10:3;return a}).append("textPath").attr("class","textpath").attr("startOffset",center_text).style("text-anchor",function(){var a=path.getPointAtLength(0);return a.y>0?"start":"end"}).attr("xlink:href","#path"+continent[i].key).text("– "+continent[i].name.toUpperCase()+" –")}drawLegend(),data_worldwide.forEach(function(a,b){var c=[];for(var d in a)if(a.hasOwnProperty(d)&&"year"!=d)for(b=0;b<a[d];b++)c.push(parseInt(d));chart_ta_worldwide.push({year:new Date(a.year,0),data:c})})}function update(){var a=nodes.filter(function(a){if(2==a.depth){var b=-1;countries.forEach(function(c,d){c.name==a.key&&(b=d)}),-1!=b?countries[b].ftas=a.ta_total_arr.length:countries.push({name:a.key,ftas:a.ta_total_arr.length})}return!a.children});if(ftas_new_arr=[],ftas_total_arr=[],tas_current_worldwide="",nodes.forEach(function(a){if(1==a.depth){var b=[],c=[];a.children.forEach(function(a){a.ta_total_arr.forEach(function(a){0==a||isInArray(a,ftas_total_arr)||ftas_total_arr.push(a),0==a||isInArray(a,c)||c.push(a)}),a.imports.forEach(function(a){0==a.id||isInArray(a.id,ftas_new_arr)||ftas_new_arr.push(a.id),0==a.id||isInArray(a.id,b)||b.push(a.id)})});var d=-1;continent.forEach(function(b,c){b.key==a.name&&(d=c)}),-1!=d&&(continent[d].ftas_new_arr=b,continent[d].ftas_total_arr=c)}}),drawLinks(links,"current"),0==isSafari&&(-1==prevHistoryDrawing||historyDrawinglimit>prevHistoryDrawing||prevHistoryDrawing==historyDrawinglimit&&current.pos-1<historyDrawinglimit)){prevHistoryDrawing=current.pos-1<historyDrawinglimit?current.pos-1:historyDrawinglimit;for(var b=[],c=0;prevHistoryDrawing>=c;c++){var d=b.concat(data_prepared[c][1]);b=d}drawLinks(b,"history")}svg.selectAll(".node").data(a).attr("class",function(a){var b="node "+formatBlank(a.name);return a.id&&(b+=" show ",a.id.forEach(function(a){b+="ftaID_"+a.toString()+" "})),b}),svg.selectAll(".circleCountry").data(a).transition().duration(600).attr("r",function(a){var b=0;return countries.forEach(function(c){c.name==a.key&&(b=c.ftas)}),linearScale(b)}),$("#showTotal .num").text(ftas_total_arr.length),$("#showCurrent .num").text("+"+ftas_new_arr.length),displayTADetails(ftas_new_arr,"worldwide","currentTAs"),metaChart(currentCountry),drawLegend()}function drawLinks(a,b,c){if(link_data=[],bundle(a).map(function(a){a.source=a[0],a.target=a[a.length-1];var b={};if(b.taID=a.target.id,b.depth=a.target.depth_,a.source.parent.key==a.target.parent.key){e=a[1];var c=a.source.x,d=a.target.x,f=c>d?c-d:d-c,g=d>c?c+f/2:d+f/2,h=g>e.x?g-e.x:null,i=a.source.y,j=a.target.y,k=i>j?i-j:j-i,l=j>i?i+k/2:j+k/2,m=l>e.y?l-e.y:null,n=e.y>innerRadius?-1:1;e._x=e.x+h,e._y=e.y+m*n*2.5,b.data=line_intern(a)}else b.data=line_extern(a);link_data.push(b)}),"current"==b){if(link_data_grouped=[],link_data.forEach(function(a){var b=-1;if(link_data_grouped.forEach(function(c,d){c.id==a.taID&&(b=d)}),-1!=b)link_data_grouped[b].path+=" "+a.data,++link_data_grouped[b].members;else{if(null!==a.depth||0==a.depth)var c=colorsDepth_Line(a.depth);else var c=color_noDepth;link_data_grouped.push({id:a.taID,color:c,path:a.data,members:1})}}),link_data_grouped.sort(function(a,b){return d3.descending(a.path.length,b.path.length)}),0==screenshot&&clearScreen(1),link_data_grouped.forEach(function(a){canvas_draw_lines(a.path,1,a.color,a.members)}),1==isSafari){var d=document.getElementById("lines_current_canvas"),f=d.toDataURL(),g=document.getElementById("lines_current_img");g.src=f,g.style.width=d.style.width,g.style.height=d.style.height}}else if("total"==b){if(link_data_grouped_all=[],link_data.forEach(function(a){var b=-1;if(link_data_grouped_all.forEach(function(c,d){c.id==a.taID&&(b=d)}),-1!=b)link_data_grouped_all[b].path+=" "+a.data;else{if(null!==a.depth||0==a.depth)var c=colorsDepth_Line(a.depth);else var c=color_noDepth;link_data_grouped_all.push({id:a.taID,color:c,path:a.data})}}),"hover"==c){if(link_data_grouped_all.forEach(function(a){canvas_draw_lines(a.path,5,a.color,4)}),1==isSafari){var d=document.getElementById("lines_total_selected_canvas"),f=d.toDataURL(),g=document.getElementById("lines_total_selected_img");g.src=f,g.style.width=d.style.width,g.style.height=d.style.height}}else if(link_data_grouped_all.sort(function(a,b){return d3.descending(a.path.length,b.path.length)}),link_data_grouped_all.forEach(function(a){canvas_draw_lines(a.path,4,a.color,link_data.length)}),1==isSafari){var d=document.getElementById("lines_total_canvas"),f=d.toDataURL(),g=document.getElementById("lines_total_img");g.src=f,g.style.width=d.style.width,g.style.height=d.style.height}}else if(0==isSafari){var h="";link_data.forEach(function(a){h+=" "+a.data}),canvas_draw_lines(h,0,"rgba(226,234,238,1)",link_data.length)}}function clearScreen(a){if(a)context[a].save(),context[a].setTransform(1,0,0,1,0,0),context[a].clearRect(0,0,2*width,2*height),context[a].restore();else for(i=0;6>i;i++)0==i&&prevHistoryDrawing>=historyDrawinglimit&&current.pos-1>=historyDrawinglimit||(context[i].save(),context[i].setTransform(1,0,0,1,0,0),context[i].clearRect(0,0,2*width,2*height),context[i].restore());1==isSafari&&(d3.select("#lines_current_selected_img").attr("src",img_blank),d3.select("#lines_current_selected_hover_img").attr("src",img_blank))}function canvas_draw_lines(a,b,c,d){var e=.7;"#fed02f"==c&&(e=.9);var f=radius,g=radius,h=.2;(0!=b||1==screenshot)&&(1==d?(h=.5,e=1):5>d?(h=.4,e=.9):30>d?(h=.3,e=.8):70>d?(h=.3,e=.8):d>1e3?(h=.3,e=.4):d>2500?(h=.1,e=.2):d>500&&(h=.1)),1==screenshot&&("#fed02f"==c&&(e=.8),d>1500&&(e=.2),1==isSafari?$(".img_"+b).hasClass("fadeOut")&&d>1500?e=.02:$(".img_"+b).hasClass("fadeOut")&&(e=.05):$(context[b].canvas).hasClass("fadeOut")&&d>1500?e=.02:$(context[b].canvas).hasClass("fadeOut")&&(e=.05),b=10,f=radius-radius/50,g=radius+10);var i=new CanvablePath(a);context[b].strokeStyle=c,context[b].lineJoin=context.lineCap="round",context[b].lineWidth=h,context[b].save(),context[b].globalAlpha=e,context[b].translate(f,g),i.draw(context[b]),context[b].stroke(),context[b].restore()}function mouseoveredNode(a,b){ta_click=!1,$("#showCurrent").hasClass("active")||$("#showCurrent").click(),currentCountry=a.name,"current"==viewStatus&&(hideAllNodesLinksCurrent(),showAllContinents(),"Worldwide"==currentCountry?isSafari?d3.select("#lines_current_selected_img").classed("fadeOut",!0):d3.select("#lines_current_selected_canvas").classed("fadeOut",!0):isSafari?d3.select("#lines_current_selected_img").classed("fadeOut",!1):d3.select("#lines_current_selected_canvas").classed("fadeOut",!1)),0==screenshot&&(clearScreen(2),clearScreen(3)),"click"==b?showTa(a.id):showTa(a.id,null,"hover"),$("#e1").select2("data",{id:1,text:a.key}),$("#showTotal .num").text(a.ta_total_arr.length),$("#showCurrent .num").text("+"+a.imports.length);var c=[];a.imports.forEach(function(a){c.push(a.id)}),displayTADetails(c,b,"currentTAs"),current_ta_total_arr=a.ta_total_arr,metaChart(currentCountry,"update")}function mouseClickNode(a,b){if(mouseoveredNode(a,"click",b),selectItem=this,"Worldwide"!=currentCountry){var c=currentCountry.split(".");c=c[1]}else var c="Worldwide";location.hash=current.val+"_"+formatBlank(c)}function mouseoveredContinent(a,b){currentCountry=a,"current"==viewStatus&&(hideAllNodesLinksCurrent(),hideAllContinents(),"Worldwide"==currentCountry?isSafari?d3.select("#lines_current_selected_img").classed("fadeOut",!0):d3.select("#lines_current_selected_canvas").classed("fadeOut",!0):isSafari?d3.select("#lines_current_selected_img").classed("fadeOut",!1):d3.select("#lines_current_selected_canvas").classed("fadeOut",!1));var c=-1;continent.forEach(function(b,d){b.key==a&&(c=d)});var d=continent[c].ftas_new_arr,e=continent[c].ftas_total_arr,f="EU"==a?"Europe":"AS"==a?"Asia":"AF"==a?"Africa":"SA"==a?"South America":"OC"==a?"Oceania":"NA"==a?"North America":"";$("#e1").select2("data",{id:1,text:f}),$("#showTotal .num").text(e.length),$("#showCurrent .num").text("+"+d.length),0==screenshot&&(clearScreen(2),clearScreen(3)),"click"==b?showTa(d):showTa(d,null,"hover"),displayTADetails(d,b,"currentTAs"),current_ta_total_arr=e,metaChart(currentCountry,"update")}function mouseClickContinent(a){if(mouseoveredContinent(a,"click"),selectItem=this,"Worldwide"!=currentCountry)var b=a;else var b="Worldwide";location.hash=current.val+"_"+formatBlank(b)}function mouseoveredLegendDepth(a,b){hideAllNodesLinksCurrent(),isSafari?d3.select("#lines_current_selected_img").classed("fadeOut",!0):d3.select("#lines_current_selected_canvas").classed("fadeOut",!0),clearScreen(3),showTa(a.ids,null,"hover"),svg_legend_depth.selectAll(".legend_de").classed("fadeOut",!0),d3.select(b).classed("fadeOut",!1)}function mouseoutedLegendDepth(){showAllNodesLinks(),svg_legend_depth.selectAll(".legend_de").classed("fadeOut",!1)}function mouseoveredLegendAmount(a,b){hideAllNodesLinksCurrent(),isSafari?(d3.select("#lines_current_selected_img").classed("fadeOut",!0),d3.select("#lines_current_selected_hover_img").classed("fadeOut",!0)):(d3.select("#lines_current_selected_canvas").classed("fadeOut",!0),d3.select("#lines_current_selected_hover_canvas").classed("fadeOut",!0)),a.ids.forEach(function(a){svg.selectAll(".node."+formatBlank(a)).classed("fadeOut",!1).classed("node--active",!0)}),svg_legend_connections.selectAll(".legend_co").classed("fadeOut",!0),d3.select(b).classed("fadeOut",!1)}function mouseoutedLegendAmount(){showAllNodesLinks(),svg_legend_connections.selectAll(".legend_co").classed("fadeOut",!1)}function resetSelection(){selectItem=!1,ta_click=!1,$("#showCurrent").hasClass("active")||$("#showCurrent").click(),showAllNodesLinks(),showAllContinents(),$("#e1").select2("val",""),$("#showTotal .num").text(ftas_total_arr.length),$("#showCurrent .num").text("+"+ftas_new_arr.length),$("#currentTAs .items").fadeOut(100,function(){$("#currentTAs .items").html(""),$("#currentTAs .items").append(tas_current_worldwide),$("#currentTAs .items li").hide(),$("#currentTAs .items").show(),$("#currentTAs .items li").each(function(a){++a,$(this).delay(10*a).fadeIn(30)}),tas_hover()}),svg.selectAll(".node").classed("node--source",!1),currentCountry="Worldwide",metaChart(currentCountry,"update"),location.hash=current.val+"_"+currentCountry}function displayTADetails(a,b,c){function d(){if(h.sort(function(a,b){return a.depth>b.depth?-1:a.depth<b.depth?1:a.connections>b.connections?-1:a.connections<b.connections?1:0}),h.forEach(function(a){function d(a,b){for(var c=a.replace("#","").match(/(.{2})/g),d=3;d--;)c[d]=parseInt(c[d],16);return"undefined"==typeof b?"rgb("+c.join(", ")+")":"rgba("+c.join(", ")+", "+b+")"}var e=null!=a.depth?colorsDepth_Line(a.depth):color_noDepth;e=d(e,.5);var h="<span class='titel'>"+a.name+"</span>";if("hover"!=b){var i="<li><span>"+a.connections+" Member States, Signed "+a.year+"</span></li>",j="<li><span>"+typeMemb[a.type-1]+" Agreement</span></li>";if(a.depth)var k="<li><span>Depth Index "+a.depth;else var k="<li><span>Depth Index not available</span></li>";if("undefined"!=typeof a.reason[0]){var l=" due to Statements about ";a.reason.forEach(function(b,c){c==a.reason.length-1&&(l+=" and "),l+=reasons[b],c!=a.reason.length-1&&c!=a.reason.length-2&&(l+=", ")})}else var l="";if(l+="</span></li>","allTAs"==c)var m=a.year;else var m="";f="<li class='ftaID_"+a.id+" "+m+"' style='border-bottom: 1px solid "+e+"'>"+h+"<ul class='details'>"+i+j+k+l+"</ul></li>"}else f="<li class='ftaID_"+a.id+"' style='border-bottom: 1px solid "+e+"'>"+h+"</li>";g+=f}),"Worldwide"!=currentCountry&&"worldwide"!=b||""==tas_current_worldwide&&"Worldwide"==currentCountry||"total"==viewStatus){$("#"+c+" .items").html("");var a="";a=2==currentCountry.length?"EU"==currentCountry?"Europe":"AS"==currentCountry?"Asia":"AF"==currentCountry?"Africa":"SA"==currentCountry?"South America":"OC"==currentCountry?"Oceania":"NA"==currentCountry?"North America":"":currentCountry.substring(3,currentCountry.length),$("#"+c+" .items").append(""!=g?g:'<span style="margin:10px;display:block;">'+a+" has not signed<br>any trade agreement this year.</span>"),tas_hover()}"worldwide"==b&&(tas_current_worldwide=g)}var e,f,g=[],h=[];if(void 0!==window.Worker){var i=new Worker("js/worker/12_task.js");i.addEventListener("message",function(a){"taDetailsBack"==a.data.cmd&&(h=a.data.tas_detail_arr,e=a.data.json,d())},!1),i.postMessage({cmd:"taDetails",data:a,data_tas:data_tas,status:b})}else a.forEach(function(a){var c=-1;data_tas.forEach(function(b,d){b.id==a&&(c=d)}),-1!=c?(e="hover"==b?{id:a,depth:data_tas[c].depth,name:data_tas[c].name}:{id:a,depth:data_tas[c].depth,name:data_tas[c].name,reason:data_tas[c].reason,connections:data_tas[c].pa_count,type:data_tas[c].type,year:data_tas[c].year},h.push(e)):console.log("bug")}),d()}function showAllNodesLinks(){svg.selectAll(".node").classed("fadeOut",!1).classed("node--active",!1),"current"==viewStatus&&(1==isSafari?(d3.select("#lines_current_img").classed("fadeOut",!1),d3.select("#lines_current_selected_hover_img").classed("fadeOut",!1).classed("hide",!0)):(d3.select("#lines_history_canvas").classed("fadeOut",!1),d3.select("#lines_current_canvas").classed("fadeOut",!1),d3.select("#lines_current_selected_hover_canvas").classed("fadeOut",!1).classed("hide",!0)),clearScreen(2))}function showAllNodesLinksCurrent(){svg.selectAll(".node").classed("fadeOut",!1).classed("node--active",!1),1==isSafari?(d3.select("#lines_current_img").classed("fadeOut",!1),d3.select("#lines_current_selected_img").classed("fadeOut",!1)):(d3.select("#lines_history_canvas").classed("fadeOut",!1),d3.select("#lines_current_canvas").classed("fadeOut",!1),d3.select("#lines_current_selected_canvas").classed("fadeOut",!1)),clearScreen(3)}function hideAllNodesLinksCurrent(){if(svg.selectAll(".node").classed("fadeOut",!0).classed("node--source",!1),"Worldwide"!=currentCountry){var a=".node."+formatBlank(currentCountry);d3.select(a).classed("node--active",!0).classed("node--source",!0)}1==isSafari?(d3.select("#lines_current_img").classed("fadeOut",!0),d3.select("#lines_current_selected_hover_img").classed("hide",!1)):(d3.select("#lines_history_canvas").classed("fadeOut",!0),d3.select("#lines_current_canvas").classed("fadeOut",!0),d3.select("#lines_current_selected_hover_canvas").classed("hide",!1))}function showAllContinents(){svg.selectAll(".continent").classed("fadeOut",!1).classed("node--active",!1)}function hideAllContinents(){if(svg.selectAll(".continent").classed("fadeOut",!0).classed("node--active",!1),"Worldwide"!=currentCountry){var a=".continent.continent_"+formatBlank(currentCountry);d3.select(a).classed("node--active",!0)}}function hideAllNodesLinksTotal(){svg.selectAll(".node").classed("fadeOut",!0),1==isSafari?d3.select("#lines_total_img").classed("fadeOut",!0):d3.select("#lines_total_canvas").classed("fadeOut",!0)}function showTa(a,b,c){function d(a,d){function e(){m.length>0&&("hover"==c?_links_sel_all_selected.push(m):_links_sel_all.push(m),drawLinks(m,"total",c))}if("current"==viewStatus){svg.selectAll(".node.ftaID_"+a).classed("fadeOut",!1).classed("node--active",!0);var f=-1;if(link_data_grouped.forEach(function(b,c){b.id==a&&(f=c)}),-1!=f)if("hover"===c){if(_links_sel_current_hover.push(link_data_grouped[f]),canvas_draw_lines(link_data_grouped[f].path,3,link_data_grouped[f].color,4),1==isSafari){var g=document.getElementById("lines_current_selected_hover_canvas"),h=g.toDataURL(),i=document.getElementById("lines_current_selected_hover_img");i.src=h,i.style.width=g.style.width,i.style.height=g.style.height}}else if(_links_sel_current.push(link_data_grouped[f]),canvas_draw_lines(link_data_grouped[f].path,2,link_data_grouped[f].color,4),1==isSafari){var g=document.getElementById("lines_current_selected_canvas"),h=g.toDataURL(),i=document.getElementById("lines_current_selected_img");i.src=h}}else{if("array"==d)var j=a.year,k=a.id;else var j=b,k=a;var l,m=[];if(k>=0)$.each(years,function(a,b){b.val==j&&(l=data_prepared[years[b.pos].pos][1])}),l.forEach(function(a){a.target.id==k&&(m.push(a),svg.selectAll(".node."+formatBlank(a.source.name)).classed("hide",!1).classed("fadeOut",!1).classed("node--active",!0),svg.selectAll(".node."+formatBlank(a.target.name)).classed("hide",!1).classed("fadeOut",!1).classed("node--active",!0))}),e();else{var n=[];if(void 0!==window.Worker){var o=new Worker("js/worker/12_task.js");o.addEventListener("message",function(a){"totalWorldwideBack"==a.data.cmd&&($(".loader").hide(),m=a.data.links,n=a.data.countries,n.forEach(function(a){svg.selectAll(".node."+formatBlank(a)).classed("hide",!1).classed("fadeOut",!1).classed("node--active",!0)}),e())},!1),o.postMessage({cmd:"totalWorldwide",data:data_prepared,year:j})}else{for(var p=0;j-1>=p;p++){$(".loader").hide();var q=m.concat(data_prepared[p][1]);m=q,data_prepared[p][1].forEach(function(a){isInArray(a.source.name,n)||n.push(a.source.name),isInArray(a.target.name,n)||n.push(a.target.name)})}n.forEach(function(a){svg.selectAll(".node."+formatBlank(a)).classed("hide",!1).classed("fadeOut",!1).classed("node--active",!0)}),e()}}}}"current"==viewStatus?(("hover"===c||0==ta_click)&&(_links_sel_current_hover=[]),"hover"!=c&&(_links_sel_current=[])):(("hover"===c||0==ta_click)&&(_links_sel_all_selected=[]),"hover"!=c&&(_links_sel_all=[])),"[object Array]"===Object.prototype.toString.call(a)?a.forEach(function(a){d(a,"array")}):"number"==typeof a&&d(a)}function tas_hover(){$(".items>li").mouseenter(function(){$(this)!=ta_click&&(ta_click=!1);var a=$(this).attr("class");if(a.length>10)var b=a.split(" "),c=b[0].substring(6,b[0].length),d="active"!=b[1]?b[1]:null;else var d=null,c=a.substring(6,a.length);c=parseInt(c),$(this).addClass("active"),"current"==viewStatus?(hideAllNodesLinksCurrent(),"Worldwide"!=currentCountry&&(isSafari?d3.select("#lines_current_selected_img").classed("fadeOut",!0):d3.select("#lines_current_selected_canvas").classed("fadeOut",!0)),clearScreen(3)):(hideAllNodesLinksTotal(),clearScreen(5)),showTa(c,d,"hover"),"Worldwide"!=currentCountry&&d3.select("#taVis").selectAll(".bar rect").style("opacity",function(a){var b=".4";return a.id==c&&(b="1"),b})}).click(function(){$(".items>li").removeClass("active"),$(this).mouseenter(),ta_click=$(this)}).mouseleave(function(){0==ta_click&&($(this).removeClass("active"),resetTaListSelection(),"Worldwide"!=currentCountry&&d3.select("#taVis").selectAll(".bar rect").style("opacity","1"))})}function resetTaListSelection(){d3.selectAll(".node--active").classed("fadeOut",!1),("Worldwide"==currentCountry||"total"==viewStatus)&&d3.selectAll(".show").classed("fadeOut",!1),"current"==viewStatus?(1==isSafari?(d3.select("#lines_current_selected_hover_img").classed("hide",!0),"Worldwide"!=currentCountry?(d3.select("#lines_current_selected_img").classed("fadeOut",!1),d3.select("#lines_current_img").classed("fadeOut",!0)):(d3.select("#lines_current_selected_img").classed("fadeOut",!0),d3.select("#lines_current_img").classed("fadeOut",!1))):(d3.select("#lines_current_selected_hover_canvas").classed("hide",!0),"Worldwide"!=currentCountry?(d3.select("#lines_current_selected_canvas").classed("fadeOut",!1),d3.select("#lines_current_canvas").classed("fadeOut",!0)):(d3.select("#lines_history_canvas").classed("fadeOut",!1),d3.select("#lines_current_selected_canvas").classed("fadeOut",!0),d3.select("#lines_current_canvas").classed("fadeOut",!1))),clearScreen(3)):(1==isSafari?d3.select("#lines_total_img").classed("fadeOut",!1):d3.select("#lines_total_canvas").classed("fadeOut",!1),clearScreen(5))}function updateSlider(a){current=years[parseInt(a)],$(".currentYear").text(current.val),$("#showTotal .year").text(current.val),$("#showCurrent .year").text(current.val)}function animate(){timer=window.requestAnimationFrame(animate),currentTime=(new Date).getTime(),delta=currentTime-lastTime,delta>interval&&(val==sliderValMax+1?(window.cancelAnimationFrame(timer),$("#play span").removeClass("icon-pause"),$("#play span").addClass("icon-play"),$(".playBt").toggleClass("play")):$("#slider").val(val++),lastTime=currentTime-delta%interval)}function initAnime(){timer_=window.requestAnimationFrame(initAnime),currentTime_=(new Date).getTime(),delta_=currentTime_-user_interaction_init_time,delta_>interval_&&(0==user_interaction_init&&$("#play").click(),window.cancelAnimationFrame(timer_))}function createSelectBox(a){for(var b=0,c=[],d=0;d<a.length;d++){var e={};"EU"==a[d].key?e.text="Europe":"AS"==a[d].key?e.text="Asia":"OC"==a[d].key?e.text="Oceania":"AF"==a[d].key?e.text="Africa":"SA"==a[d].key?e.text="South America":"NA"==a[d].key&&(e.text="North America"),e.id=500+d,e.name=a[d].key,e.children=[],select_list_arr_cont.push(a[d].key);for(var f=0;f<a[d].children.length;f++)e.children.push({id:b,text:a[d].children[f].key,name:a[d].children[f].name}),select_list_arr.push(formatBlank(a[d].children[f].key)),b++;c.push(e)}$("#e1").select2({minimumResultsForSearch:0,minimumInputLength:0,allowClear:!0,placeholder:"Worldwide",width:"260px",dropdownCssClass:"bigdrop",data:c}).on("change",function(a){if(selectItem=!1,svg.selectAll(".node").classed("hide",!1).classed("node--active",!1).classed("node--source",!1),a.added&&!a.added.children){var b=formatBlank(a.added.name);d3.select(".node."+b).each(function(){d3.select(this).on("click").apply(this,arguments)}),ga("send","event","new_country_val",b)}else if(a.added&&a.added.children){var b=formatBlank(a.added.name);d3.select(".continent_"+b).each(function(){d3.select(this).on("click").apply(this,arguments)}),ga("send","event","new_country_val",b)}else resetSelection(),ga("send","event","new_country_val","Worldwide");if(2==currentCountry.length)var c=currentCountry;else if("Worldwide"!=currentCountry){var c=currentCountry.split(".");c=c[1]}else var c="Worldwide";location.hash=current.val+"_"+formatBlank(c),user_interaction_init=!0})}function metaChart(a){var b=[];"Worldwide"!=a&&2==a.length?data.forEach(function(c){var d=[];if(c.data.forEach(function(b,c){b.name.substring(0,2)==a&&d.push(c)}),d.length>0){var e=[];d.forEach(function(a){c.data[a].imports.forEach(function(a){e.push({id:a.id,depth:a.depth})})});var f=e.reduce(function(a,b){var c=a.filter(function(a){return b.id==a.id});return 0==c.length&&a.push(b),a},[]);f.sort(function(a,b){return a.depth-b.depth}),b.push({year:new Date(c.year,0),data:f})}}):"Worldwide"!=a?data.forEach(function(c){var d=-1;if(c.data.forEach(function(b,c){b.name==a&&(d=c)}),-1!=d){var e=[];c.data[d].imports.forEach(function(a){e.push({id:a.id,depth:a.depth})}),e.sort(function(a,b){return a.depth-b.depth}),b.push({year:new Date(c.year,0),data:e})}}):b=chart_ta_worldwide,drawMetaChart("#taVis",b)}function drawMetaChart(a,b){b.forEach(function(a){var b=0;a.data.length>0?(a.data_=a.data.map(function(a){var c,d;return"Worldwide"==currentCountry?(c=--a,d=-1):(c=a.depth,d=a.id),{depth:c,id:d,y0:b,y1:++b}}),a.total=a.data_[a.data_.length-1].y1):(a.data_=[],a.total=0)});var c=graph_taVis;x.domain(b.map(function(a){return a.year})),y.domain([0,d3.max(b,function(a){var b=a.total<10?10:a.total;return b})]),c.select(".grid").call(d3.svg.axis().scale(y).orient("left").tickSize(-meta_width,0,0).tickFormat("")),c.select(".y.axis").call(yAxis);var d=c.selectAll(".bar").data(b);d.enter().append("g").attr("class","bar").attr("transform",function(a){return"translate("+x(a.year)+",0)"}).on("mouseover",function(a){var b="<span class='value'>+"+a.total+"</span><span class='name'>"+formatDate(a.year)+"</span>",c="<span class='value shadow_back'>+"+a.total+"</span><span class='name shadow_back'>"+formatDate(a.year)+"</span>";tip.html(b+c),tip.show()}).on("mousemove",function(){return tip.style("top",d3.event.pageY-2+"px").style("left",d3.event.pageX+0+"px")}).on("mouseout",function(){return tip.hide()}).on("click",function(a){return $.each(years,function(b,c){c.val==formatDate(a.year)&&(current=years[c.pos])}),$("#slider").val(current.pos),!0}),d.transition().duration(100).attr("opacity",function(a){return res=a.year.getFullYear()<=current.val?"1":".25"});var e=d.selectAll("rect").data(function(a){return a.data_});e.enter().append("rect").attr("width",x.rangeBand()).attr("y",function(a){return y(a.y1)}).attr("height",function(a){return y(a.y0)-y(a.y1)}).style("fill",function(a){if(-1!==a.depth)var b=colorsDepth_Line(a.depth);else var b=color_noDepth;return b}).style("opacity",0).transition().duration(100).style("opacity",1),e.transition().duration(700).attr("y",function(a){return y(a.y1)}).attr("height",function(a){return y(a.y0)-y(a.y1)}).style("fill",function(a){if(-1!==a.depth)var b=colorsDepth_Line(a.depth);else var b=color_noDepth;return b}).style("opacity",1),e.exit().transition().duration(100).style("opacity",0).remove();var f=-1,g="";b.forEach(function(a,b){a.year.getFullYear()==current.val&&(f=b)}),-1!=f&&(g=b[f].total)}function drawLegend(){var a=svg_legend_depth.selectAll(".legend_de").data(function(){var a=[{depth:"Not Available",ids:[]},{depth:0,ids:[]},{depth:1,ids:[]},{depth:2,ids:[]},{depth:3,ids:[]},{depth:4,ids:[]},{depth:5,ids:[]},{depth:6,ids:[]},{depth:7,ids:[]}];return bundle(links).forEach(function(b){for(var c=b[b.length-1].depth_,d=b[b.length-1].id,e=0;8>e;e++)null!=c||isInArray(d,a[0].ids)?c!=e||isInArray(d,a[e+1].ids)||a[e+1].ids.push(d):a[0].ids.push(d)}),a});a.select(".rectDepth").transition().duration(600).attr("y",function(a){return a.ids.length>0?2:14}).attr("height",function(a){return a.ids.length>0?16:4});var b=a.enter().append("g").attr("class","legend_de").attr("transform",function(a,b){var c=0==b?4:8;return"translate("+(c+12*b)+",2)"}).on("mouseover",function(a){0==selectItem&&mouseoveredLegendDepth(a,this)}).on("mouseout",function(a){0==selectItem&&mouseoutedLegendDepth(a)});b.append("rect").attr("x",0).attr("y",function(a){return a.ids.length>0?2:14}).attr("width",12).attr("height",function(a){return a.ids.length>0?16:4}).attr("class","rectDepth").style("fill",function(a){return"Not Available"==a.depth?color_noDepth:colorsDepth_Line(a.depth)}),b.append("rect").attr("x",6).attr("y",20).attr("width",1).attr("height",3).style("fill",function(a){return"Not Available"==a.depth||0==a.depth||7==a.depth?"#ccc":"transparent"}),b.append("text").attr("x",function(a){return 0==a.depth?5:7==a.depth?-10:0}).attr("y",28).attr("dy",".35em").text(function(a){return"Not Available"==a.depth?"N.A.":0==a.depth?"0 Low":7==a.depth?"7 High":""});var c=svg_legend_connections.selectAll(".legend_co").data(function(){var a=[{amount:0,ids:[]},{amount:20,ids:[]},{amount:40,ids:[]},{amount:60,ids:[]},{amount:80,ids:[]},{amount:100,ids:[]}];
return nodes.forEach(function(b){if(2==b.depth)for(var c=b.ta_total_arr.length,d=b.name,e=0;5>e;e++)0!=c||isInArray(d,a[0].ids)?c>a[e].amount&&c<=a[e+1].amount&&!isInArray(d,a[e+1].ids)&&a[e+1].ids.push(d):a[0].ids.push(d)}),a});c.select("circle").transition().duration(600).style("stroke-opacity",function(a){return a.ids.length>0?1:.4}).style("stroke",function(a){return a.ids.length>0?"#000":"#333"});var b=c.enter().append("g").attr("class","legend_co").attr("width",20).attr("transform",function(a,b){return"translate("+20*b+",12)"}).on("mousemove",function(a){0==selectItem&&mouseoveredLegendAmount(a,this)}).on("mouseout",function(a){0==selectItem&&mouseoutedLegendAmount(a)});b.append("circle").attr("r",function(a){return linearScale(a.amount)}).attr("cx",8).attr("cy",function(a){return-linearScale(a.amount)}),b.append("rect").attr("x",7).attr("y",4).attr("width",1).attr("height",3).style("fill","#ccc"),b.append("text").attr("x",function(a,b){var c=0==b?6:5==b?1:3;return c}).attr("y",13).attr("dy",".35em").text(function(a){return a.amount}),b.append("rect").attr("x",0).attr("y",0).attr("width",24).attr("height",30).style("fill","transparent")}function sendMail(){var a="mailto:hello@ftavis.com?subject="+escape("FTA Vis Feedback");window.location.href=a}function dataURItoBlob(a){if(a.split(",")[0].indexOf("base64")>=0)var b=atob(a.split(",")[1]);else var b=unescape(a.split(",")[1]);for(var c=a.split(",")[0].split(":")[1].split(";")[0],d=new ArrayBuffer(b.length),e=new Uint8Array(d),f=0;f<b.length;f++)e[f]=b.charCodeAt(f);var g=new DataView(d),h=new Blob([g],{type:c});try{return h}catch(i){var j=window.WebKitBlobBuilder||window.MozBlobBuilder,k=new j;return k.append(d),k.getBlob(c)}}function makeScreenshot(){$(".loader").show(),screenshot=!0,country__="Worldwide"==currentCountry?"Worldwide":2==currentCountry.length?"EU"==currentCountry?"Europe":"AS"==currentCountry?"Asia":"AF"==currentCountry?"Africa":"SA"==currentCountry?"South America":"OC"==currentCountry?"Oceania":"NA"==currentCountry?"North America":"":formatBlank(currentCountry.substring(3,currentCountry.length));var a="current"==viewStatus?"in ":"from 1948 until ";time__="current"==viewStatus?current.val:current.val,fta__=0!=ta_click?ta_click.context.firstChild.innerHTML:null,null!=fta__?(fta__=fta__.trunc(27,!0),d3.select("#hiddenCanvas_text svg .h2.first").text(fta__),d3.select("#hiddenCanvas_text svg .h2.second").text("Trade Agreement"),d3.select("#hiddenCanvas_text svg .h2.third").text("Signed "+time__)):(d3.select("#hiddenCanvas_text svg .h2.first").text("Worldwide"==currentCountry?"All Trade Agreements":"All Trade Agreements of"),country__.replace(/-/gi).length>6?(d3.select("#hiddenCanvas_text svg .h2.second").text(country__.replace(/-/gi," ")),d3.select("#hiddenCanvas_text svg .h2.third").text(a+time__)):(d3.select("#hiddenCanvas_text svg .h2.second").text(country__.replace(/-/gi," ")+" "+a+time__),d3.select("#hiddenCanvas_text svg .h2.third").text(""))),$("#legend_depth svg .legend_de").clone().appendTo($("#hiddenCanvasOverlay_legend")),$("#legend_connections svg .legend_co").clone().appendTo($("#hiddenCanvasOverlay_circle")),$("#hiddenCanvasOverlay_legend .legend_de rect.rectDepth").attr("height",16).attr("y",2);var b=null!=fta__?fta__.replace(/\s+/g,"")+"_"+time__:country__.replace(/\s+/g,"")+"_"+time__,c=d3.select("#hiddenCanvas").attr("width",d+d/3).attr("height",d-30).style("width",d/multi+"px").style("height",d/multi+"px");context[10]=c.node().getContext("2d"),context[10].setTransform(multi,0,0,multi,0,0),context[10].fillStyle="#FFFFFF",context[10].fillRect(0,0,d,d),svgenie.save(d3.select("#nodes svg").node(),{name:"ftavis_"+b+".png"})}var years=[],current=[],currentCountry="Worldwide",prevHistoryDrawing=-1,historyDrawinglimit=29,sliderValMax=63,sliderVal=sliderValMax,data,data_prepared=[],data_tas,data_worldwide,nodes,links,c=0,user_interaction_init=!1,user_interaction_init_time=0,link_data=[],link_data_grouped=[],link_data_grouped_all=[],nodeHover=!1;viewStatus="current",data_update="",countries=[],ta_click=!1,selectItem=!1,typeMemb=["Bilateral","Pluriteral","Plurilateral & Third Country","Region-Region","Accession","Accession to an Agreement","Withdrawal"],reasons=["Tariff Reduction","Intellectual Property Rights Protection","Government Purchases","Technical Barriers to Trade","Services","Investments","Competition"],context=[],countriesMax=100;var ftas_new_arr=[],ftas_total_arr=[],depth_average=0,depth_average_count=0,depth_average_new_count=0,depth_new=null,tas_current_worldwide="",select_list_arr_cont=[];select_list_arr=[];var continent=[{key:"AF",name:"Africa",ftas:0,ftas_new:0,ftas_new_arr:[],ftas_total_arr:[]},{key:"AS",name:"Asia",ftas:0,ftas_new:0,ftas_new_arr:[],ftas_total_arr:[]},{key:"EU",name:"Europe",ftas:0,ftas_new:0,ftas_new_arr:[],ftas_total_arr:[]},{key:"NA",name:"North America",ftas:0,ftas_new:0,ftas_new_arr:[],ftas_total_arr:[]},{key:"SA",name:"South America",ftas:0,ftas_new:0,ftas_new_arr:[],ftas_total_arr:[]},{key:"OC",name:"Oceania",ftas:0,ftas_new:0,ftas_new_arr:[],ftas_total_arr:[]},{key:"AN",name:"Antarctica",ftas:0,ftas_new:0,ftas_new_arr:[],ftas_total_arr:[]}],screenshot=!1,colors=["#426174","#547a8d","#5894b2","#65aed6","#fed02f","#fdac2a","#fd8324","#e16861"],color_noDepth="#848a8d",colorsDepth_Circle=d3.scale.quantize().domain([0,5.5]).range(colors),colorsDepth_Line=d3.scale.quantize().domain([0,7]).range(colors),linearScale=d3.scale.linear().domain([0,countriesMax]).range([.5,4]),ua=window.navigator.userAgent,old_ie=ua.indexOf("MSIE "),new_ie=ua.indexOf("Trident/");if(old_ie>-1||new_ie>-1)var ms_ie=!0;else var ms_ie=!1;var isSafari=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0,width_mobile=window.innerWidth>0?window.innerWidth:screen.width,height_mobile=window.innerHeight>0?window.innerHeight:screen.height;if(710>height_mobile&&(height_mobile=710),600>width_mobile)var margin=0;else if(800>width_mobile)var margin=80;else if(1025>width_mobile)var margin=44;else var margin=20;if(800>width_mobile)var d=width_mobile-100;else var d=width_mobile-225-240;var diameter=width_mobile>height_mobile?height_mobile>1e3?980:height_mobile:d,width=diameter-2*margin,height=diameter-2*margin,radius=(diameter-2*margin)/2,innerRadius=radius-.36*radius;$("#continents").width(diameter-2*margin).height(diameter-2*margin),d3.select(self.frameElement).style("height",diameter+"px");var svg_circle=d3.select("#circle").append("svg").attr("width",width).attr("height",height).attr("viewBox","0 0 "+width+" "+height).attr("preserveAspectRatio","xMinYMid  meet").append("g").attr("transform","translate("+radius+","+radius+")"),ratio=window.devicePixelRatio||1,img_blank="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",lines_history=d3.select("#lines_history").append("canvas").attr("id","lines_history_canvas").attr("width",width*ratio).attr("height",height*ratio).style("width",width+"px").style("height",height+"px").attr("viewBox","0 0 "+width+" "+height).attr("preserveAspectRatio","xMinYMid  meet");context[0]=lines_history.node().getContext("2d"),context[0].setTransform(ratio,0,0,ratio,0,0);var lines_current=d3.select("#lines_current").append("canvas").attr("id","lines_current_canvas").attr("width",width*ratio).attr("height",height*ratio).style("width",width+"px").style("height",height+"px").attr("viewBox","0 0 "+width+" "+height).attr("preserveAspectRatio","xMinYMid  meet");context[1]=lines_current.node().getContext("2d"),context[1].setTransform(ratio,0,0,ratio,0,0),1==isSafari&&d3.select("#lines_current").append("img").attr("id","lines_current_img").attr("class","img_1").attr("src",img_blank).style("width",width+"px").style("height",height+"px");var lines_current_selected=d3.select("#lines_current_selected").append("canvas").attr("id","lines_current_selected_canvas").attr("width",width*ratio).attr("height",height*ratio).style("width",width+"px").style("height",height+"px").attr("viewBox","0 0 "+width+" "+height).attr("preserveAspectRatio","xMinYMid  meet");context[2]=lines_current_selected.node().getContext("2d"),context[2].setTransform(ratio,0,0,ratio,0,0),1==isSafari&&d3.select("#lines_current_selected").append("img").attr("id","lines_current_selected_img").attr("class","img_2").attr("src",img_blank).style("width",width+"px").style("height",height+"px");var lines_current_selected_hover=d3.select("#lines_current_selected_hover").append("canvas").attr("id","lines_current_selected_hover_canvas").attr("width",width*ratio).attr("height",height*ratio).style("width",width+"px").style("height",height+"px").attr("viewBox","0 0 "+width+" "+height).attr("preserveAspectRatio","xMinYMid  meet");context[3]=lines_current_selected_hover.node().getContext("2d"),context[3].setTransform(ratio,0,0,ratio,0,0),1==isSafari&&d3.select("#lines_current_selected_hover").append("img").attr("id","lines_current_selected_hover_img").attr("class","img_3").attr("src",img_blank).style("width",width+"px").style("height",height+"px");var lines_total=d3.select("#lines_total").append("canvas").attr("id","lines_total_canvas").attr("width",width*ratio).attr("height",height*ratio).style("width",width+"px").style("height",height+"px").attr("viewBox","0 0 "+width+" "+height).attr("preserveAspectRatio","xMinYMid  meet");context[4]=lines_total.node().getContext("2d"),context[4].setTransform(ratio,0,0,ratio,0,0),1==isSafari&&d3.select("#lines_total").append("img").attr("id","lines_total_img").attr("class","img_4").attr("src",img_blank).style("width",width+"px").style("height",height+"px");var lines_total_selected=d3.select("#lines_total_selected").append("canvas").attr("id","lines_total_selected_canvas").attr("width",width*ratio).attr("height",height*ratio).style("width",width+"px").style("height",height+"px").attr("viewBox","0 0 "+width+" "+height).attr("preserveAspectRatio","xMinYMid  meet");context[5]=lines_total_selected.node().getContext("2d"),context[5].setTransform(ratio,0,0,ratio,0,0),1==isSafari&&d3.select("#lines_total_selected").append("img").attr("id","lines_total_selected_img").attr("class","img_5").attr("src",img_blank).style("width",width+"px").style("height",height+"px"),1==isSafari&&$("canvas").hide();var svg=d3.select("#nodes svg").attr("width",width).attr("height",height).attr("viewBox","0 0 "+width+" "+height).attr("preserveAspectRatio","xMinYMid  meet").attr("id","main").append("g").attr("class","vis").attr("transform","translate("+radius+","+radius+")");d3.select("#nodes svg #hiddenCanvasOverlay").attr("transform","translate("+(radius+radius/2)+","+(radius+radius/2)+")");var svg_legend_depth=d3.select("#legend_depth").append("svg").attr("width","120px").attr("height","35px"),svg_legend_connections=d3.select("#legend_connections").append("svg").attr("width","120px").attr("height","35px"),bundle=d3.layout.bundle(),cluster=d3.layout.cluster().size([360,innerRadius]).separation(function(a,b){return(a.parent==b.parent?1:4)/a.depth}).value(function(a){return a.size}),line_intern=d3.svg.line.radial().interpolate("bundle").tension(.6).radius(function(a){var b=a._y?a._y:a.y;return b}).angle(function(a){var b=a._x?a._x:a.x;return b/180*Math.PI}),line_extern=d3.svg.line.radial().interpolate("bundle").tension(.4).radius(function(a){return a.y}).angle(function(a){return a.x/180*Math.PI}),bgPath=.12,r=1.44*innerRadius,arc_EU=d3.svg.arc().innerRadius(r).outerRadius(r).startAngle(.08).endAngle(1.33),arc_AS=d3.svg.arc().innerRadius(r).outerRadius(r).startAngle(1.46).endAngle(2.83),arc_OC=d3.svg.arc().innerRadius(r).outerRadius(r).startAngle(2.94).endAngle(3.37),arc_AF=d3.svg.arc().innerRadius(r).outerRadius(r).startAngle(3.46).endAngle(4.96),arc_SA=d3.svg.arc().innerRadius(r).outerRadius(r).startAngle(5.02).endAngle(5.43),arc_NA=d3.svg.arc().innerRadius(r).outerRadius(r).startAngle(5.54).endAngle(6.18);$(window).load(function(){$("#allTAs").mCustomScrollbar({theme:"dark-3",autoHideScrollbar:!0}),$("#currentTAs").mCustomScrollbar({theme:"dark-3",autoHideScrollbar:!0})}),"addEventListener"in document&&document.addEventListener("DOMContentLoaded",function(){FastClick.attach(document.body)},!1);var meter_width=180,meter_height=180,twoPi=2*Math.PI,progress=0,total=1308573,formatPercent=d3.format(".0%"),meter_arc=d3.svg.arc().startAngle(0).innerRadius(69).outerRadius(70),meter_svg=d3.select("#loading div").append("svg").attr("width",meter_width).attr("height",meter_height).append("g").attr("transform","translate("+meter_width/2+","+meter_height/2+")"),meter=meter_svg.append("g").attr("class","progress-meter");meter.append("path").attr("class","background").attr("d",meter_arc.endAngle(twoPi));var foreground=meter.append("path").attr("class","foreground"),meter_text=meter.append("text").attr("text-anchor","middle").attr("dy",".40em");width_mobile>600&&queue().defer(function(a){d3.json("data/data_.json").on("progress",function(){$("#loading span").html("Loading Data (2MB)");var a=d3.interpolate(progress,d3.event.loaded/d3.event.total);d3.transition().tween("progress",function(){return function(b){progress=a(b),foreground.attr("d",meter_arc.endAngle(twoPi*progress)),meter_text.text(formatPercent(progress))}})}).get(function(b,c){a(b,c)})}).defer(function(a){d3.json("data/data_tas_.json").get(function(b,c){a(b,c)})}).defer(function(a){d3.json("data/data_worldwide_.json").get(function(b,c){a(b,c)})}).await(function(a,b,c,d){data=b,data_tas=c,data_worldwide=d,init()});var current_ta_total_arr=[],_links_sel_all=[],_links_sel_all_selected=[],_links_sel_current=[],_links_sel_current_hover=[];$("#showCurrent").hasClass("active")||$("#showCurrent").on("click"),$("#showCurrent").on("click",function(a){if(a.preventDefault(),!$(this).hasClass("active")&&($("#legend_container").removeClass("fadeOut").css({"pointer-events":"auto"}),$("#showTotal").removeClass("active"),$(this).addClass("active"),$("#allTAs").hide(),$("#currentTAs").show(),viewStatus="current",isSafari?(d3.select("#lines_current_img").classed("hide",!1),d3.select("#lines_current_selected_img").classed("hide",!1),d3.select("#lines_current_selected_hover_img").classed("hide",!1),d3.select("#lines_total_img").classed("hide",!0),d3.select("#lines_total_selected_img").classed("hide",!0)):(d3.select("#lines_history_canvas").classed("hide",!1),d3.select("#lines_current_canvas").classed("hide",!1),d3.select("#lines_current_selected_canvas").classed("hide",!1),d3.select("#lines_current_selected_hover_canvas").classed("hide",!1),d3.select("#lines_total_canvas").classed("hide",!0),d3.select("#lines_total_selected_canvas").classed("hide",!0)),hideAllNodesLinksCurrent(),"Woldwide"!=currentCountry)){if(2==currentCountry.length)var b=500+getArrayPos(currentCountry,select_list_arr_cont);else var b=getArrayPos(formatBlank(currentCountry.substring(3,currentCountry.length)),select_list_arr);$("#e1").select2("val",b,!0)}}),$("#showTotal").on("click",function(a){if(a.preventDefault(),!$(this).hasClass("active"))if($(".loader").show(),$("#legend_container").addClass("fadeOut").css({"pointer-events":"none"}),$("#showCurrent").removeClass("active"),$(this).addClass("active"),"Worldwide"==currentCountry?displayTADetails(ftas_total_arr,"","allTAs"):displayTADetails(current_ta_total_arr,status,"allTAs"),$("#allTAs").show(),$("#currentTAs").hide(),viewStatus="total",clearScreen(4),clearScreen(5),1==isSafari?(d3.select("#lines_current_img").classed("hide",!0),d3.select("#lines_current_selected_img").classed("hide",!0).attr("src",img_blank),d3.select("#lines_current_selected_hover_img").classed("hide",!0).attr("src",img_blank),d3.select("#lines_total_img").classed("fadeOut",!1).classed("hide",!1).attr("src",img_blank),d3.select("#lines_total_selected_img").classed("fadeOut",!1).classed("hide",!1).attr("src",img_blank)):(d3.select("#lines_history_canvas").classed("hide",!0),d3.select("#lines_current_canvas").classed("hide",!0),d3.select("#lines_current_selected_canvas").classed("hide",!0),d3.select("#lines_current_selected_hover_canvas").classed("hide",!0),d3.select("#lines_total_canvas").classed("fadeOut",!1).classed("hide",!1),d3.select("#lines_total_selected_canvas").classed("fadeOut",!1).classed("hide",!1)),svg.selectAll(".node").classed("hide",!0).classed("node--active",!1),"Worldwide"!=currentCountry)if(void 0!==window.Worker){var b=new Worker("js/worker/12_task.js");b.addEventListener("message",function(a){"totalCountryBack"==a.data.cmd&&($(".loader").hide(),showTa(a.data.data))},!1),b.postMessage({cmd:"totalCountry",currentPos:current.pos,total_arr:current_ta_total_arr,data:data,data_tas:data_tas})}else{var c=-1;if(data[current.pos].data.forEach(function(a,b){a.name==currentCountry&&(c=b)}),-1!=c){var d=data[current.pos].data[c].ta_total_arr,e=[];d.forEach(function(a){var b=-1;data_tas.forEach(function(c){c.id==a&&(b=c)}),-1!=b&&e.push({id:a,year:b.year})}),showTa(e)}}else showTa(-1,current.pos)}),$("#slider").noUiSlider({start:sliderValMax,step:1,connect:"lower",range:{min:0,max:sliderValMax},format:wNumb({decimals:0})});var y=[1948,1949,1951,1953,1954,1955,1957,1958,1959,1960,1961,1962,1963,1964,1965,1966,1967,1968,1969,1970,1971,1972,1973,1974,1975,1976,1977,1978,1979,1980,1981,1982,1983,1984,1985,1986,1987,1988,1989,1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2e3,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014];$("#slider").noUiSlider_pips({mode:"values",values:[0,9,19,29,39,49,sliderValMax],format:wNumb({encoder:function(a){return y[parseInt(a)]}}),density:4}),$("#slider").on({slide:function(a,b){updateSlider(b)},set:function(a,b){if(updateSlider(b),clearScreen(),ta_click=!1,$(".items>li").removeClass("active"),$("#showCurrent").hasClass("active")||$("#showCurrent").click(),nodes=data_prepared[current.pos][0],links=data_prepared[current.pos][1],update(),sliderVal=parseInt(b),0==playStatus){if(2==currentCountry.length)var c=currentCountry;else if("Worldwide"!=currentCountry){var c=currentCountry.split(".");c=c[1]}else var c="Worldwide";location.hash=current.val+"_"+formatBlank(c)}"Worldwide"!=currentCountry?2==currentCountry.length?d3.select(".continent.continent_"+currentCountry).each(function(){d3.select(this).on("click").apply(this,arguments)}):d3.select(".node."+formatBlank(currentCountry)).each(function(a){mouseClickNode(a,a.name)}):isSafari?d3.select("#lines_current_img").classed("fadeOut",!1):(d3.select("#lines_current_canvas").classed("fadeOut",!1),d3.select("#lines_history_canvas").classed("fadeOut",!1)),0==playStatus&&ga("send","event","new_slider_val",current.val),user_interaction_init=!0},mousemove:function(a){var b=$(this).width(),c=$(this).offset(),d=Math.round((a.clientX-c.left)/b*sliderValMax);if(d>=0&&sliderValMax>=d){var e=years[parseInt(d)];$(".currentYear").text(e.val)}"undefined"!=typeof e&&svg_taVis.selectAll(".bar").attr("opacity",function(a){return res=a.year.getFullYear()<=e.val?"1":".25"})},mouseleave:function(){var a=years[parseInt(sliderVal)];$(".currentYear").text(a.val),"undefined"!=typeof a&&svg_taVis.selectAll(".bar").attr("opacity",function(b){return res=b.year.getFullYear()<=a.val?"1":".25"})}}),function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}();var timer,playStatus=!1,val,interval=2500,lastTime=(new Date).getTime(),currentTime=0,delta=0;$("#play").on("click",function(a){a.stopPropagation(),$(this).hasClass("play")?(cancelAnimationFrame(timer),playStatus=!1,$("#play span").removeClass("icon-pause"),$("#play span").addClass("icon-play")):(playStatus=!0,$("#play span").removeClass("icon-play"),$("#play span").addClass("icon-pause"),val=$("#slider").val(),val>=sliderValMax&&(val=-1),animate()),$(this).toggleClass("play")}),$("#prev").on("click",function(){0==sliderVal&&(sliderVal=sliderValMax+1),sliderVal--,$("#slider").val(sliderVal)}),$("#next").on("click",function(){sliderVal==sliderValMax&&(sliderVal=-1),sliderVal++,$("#slider").val(sliderVal)});var timer_,interval_=1e3/.14,currentTime_=0,delta_=0,chart_ta_worldwide=[],meta_margin={top:35,right:0,bottom:20,left:0},meta_width=260-meta_margin.left-meta_margin.right,meta_height=150-meta_margin.top-meta_margin.bottom,formatDate=d3.time.format("%Y"),bisectDate=d3.bisector(function(a){return a.year}).left,x=d3.scale.ordinal().rangeRoundBands([0,meta_width],.15),y=d3.scale.linear().rangeRound([meta_height,0]),svg_taVis=d3.select("#taVis").append("svg").attr("width",meta_width+meta_margin.left+meta_margin.right).attr("height",meta_height+meta_margin.top+meta_margin.bottom).append("g").attr("transform","translate("+meta_margin.left+","+meta_margin.top+")"),graph_taVis=svg_taVis.append("g"),focus_taVis=svg_taVis.append("g"),xAxis=d3.svg.axis().scale(x).orient("bottom").tickSize(2,0).tickFormat(formatDate);graph_taVis.append("g").attr("class","grid horizontal");var yAxis=d3.svg.axis().scale(y).orient("right").ticks(3).tickFormat(function(a){return"+"+a});graph_taVis.append("g").attr("class","y axis").attr("transform","translate(-8,0)");var tip=d3.tip().attr("class","d3-tip").offset([-10,0]).html(function(){return""});svg_taVis.call(tip),$(function(){$("a[href*=#]:not([href=#])").click(function(){if(location.pathname.replace(/^\//,"")==this.pathname.replace(/^\//,"")&&location.hostname==this.hostname){var a=$(this.hash);if(a=a.length?a:$("[name="+this.hash.slice(1)+"]"),a.length)return $("html,body").animate({scrollTop:a.offset().top},800),!1}})}),$("#fullscreen").on("click",function(){$("#fullscreen span").hasClass("icon-enlarge2")?($("#allTAs").addClass("active"),$("#currentTAs").addClass("active"),$("#fullscreen span").removeClass("icon-enlarge2").addClass("icon-shrink2"),$("#sidebar").addClass("enlarge")):($("#allTAs").removeClass("active"),$("#currentTAs").removeClass("active"),$("#fullscreen span").removeClass("icon-shrink2").addClass("icon-enlarge2"),$("#sidebar").removeClass("enlarge"))}),$(document).keyup(function(a){27==a.keyCode&&$("#e1").select2("val","").trigger("change"),39==a.keyCode&&$("#next").click(),37==a.keyCode&&$("#prev").click(),9==a.keyCode&&$("#play").click()});var multi=4,d=height*multi,country__,time__,fta__,svgenie=function(){"use strict";function a(a){var b=document.createEvent("MouseEvents");return b.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),a.dispatchEvent(b)}var b=function(a){return"undefined"!=typeof window.XMLSerializer?(new window.XMLSerializer).serializeToString(a):"undefined"!=typeof a.xml?a.xml:""},c=function(a,c,d){function e(){"current"==viewStatus?("Worldwide"!=currentCountry&&$.each(_links_sel_current,function(a,b){canvas_draw_lines(b.path,2,b.color,4)}),drawLinks(links,"current"),$.each(_links_sel_current_hover,function(a,b){canvas_draw_lines(b.path,3,b.color,4)})):(_links_sel_all.forEach(function(a){drawLinks(a,"total","")}),_links_sel_all_selected.forEach(function(a){drawLinks(a,"total","hover")}));var c=-radius/50;canvg("hiddenCanvas",b(a),{ignoreMouse:!0,ignoreAnimation:!0,ignoreDimensions:!0,ignoreClear:!0,offsetX:0+c,offsetY:10,renderCallback:function(){}}),$("#hiddenCanvas_continents .europe").attr("x",c+radius+radius/1.8).attr("y",radius/3.5),$("#hiddenCanvas_continents .asia").attr("x",c+radius+radius/1.5).attr("y",radius+radius/1.5),$("#hiddenCanvas_continents .oceania").attr("x",c- -c+radius).attr("y",radius+radius-radius/10),$("#hiddenCanvas_continents .africa").attr("x",c+radius/5).attr("y",radius+radius/2),$("#hiddenCanvas_continents .sa").attr("x",c+radius/10).attr("y",radius-radius/2.5),$("#hiddenCanvas_continents .na").attr("x",c+radius-radius/1.5).attr("y",radius/3.5),canvg("hiddenCanvas",b(d3.select("#hiddenCanvas_continents svg").node()),{ignoreMouse:!0,ignoreAnimation:!0,ignoreDimensions:!0,ignoreClear:!0,offsetX:0,offsetY:0,renderCallback:function(){}}),canvg("hiddenCanvas",b(d3.select("#hiddenCanvas_text svg").node()),{ignoreMouse:!0,ignoreAnimation:!0,ignoreDimensions:!0,ignoreClear:!0,offsetX:2*radius-radius/15,offsetY:radius/2+radius/15,renderCallback:function(){$(".loader").hide();var a=d3.select("#hiddenCanvas").node();d(a)}})}if("string"==typeof a&&(console.log(a),a=document.getElementById(a)),void 0!==window.Worker&&"Worldwide"==currentCountry&&0==ta_click&&"current"==viewStatus&&0==isSafari){var f=new Worker("js/worker/13_tasksScreenhot.js");f.addEventListener("message",function(a){"calcHistoryBack"==a.data.cmd&&(drawLinks(a.data.data,"history"),e())},!1),f.postMessage({cmd:"calcHistory",current:current.pos-1,data:data_prepared})}else e()},d=function(a,b,d){c(a,b,function(a){d(a.toDataURL("image/png"),a)})},e=function(a,b){d(a,b,function(a,c){f({data:a,canvas:c,name:b.name||"picture.png"})})},f=function(b){screenshot=!1;var c=document.createElement("a");if(null!=c.download){var d=dataURItoBlob(b.data),e=window.URL.createObjectURL(d);if(c.href=e,c.download=b.name,a(c),2==currentCountry.length)var f=currentCountry;else if("Worldwide"!=currentCountry){var f=currentCountry.split(".");f=f[1]}else var f="Worldwide";return void(location.hash=current.val+"_"+formatBlank(f))}if(isSafari){var d=dataURItoBlob(b.data),e=window.URL.createObjectURL(d);if(window.open(e),2==currentCountry.length)var f=currentCountry;else if("Worldwide"!=currentCountry){var f=currentCountry.split(".");f=f[1]}else var f="Worldwide";return void(location.hash=current.val+"_"+formatBlank(f))}return window.navigator.msSaveBlob?void b.canvas.toBlob(function(a){window.navigator.msSaveBlob&&window.navigator.msSaveBlob(a,b.name)},"image/png"):void 0};return{save:e,toCanvas:c,toDataURL:d}}();String.prototype.trunc=function(a,b){var c=this.length>a,d=c?this.substr(0,a-1):this;return d=b&&c?d.substr(0,d.lastIndexOf(" ")):d,c?d+"...":d},$("#share").on("click",function(){if($("#shareOverlay").hasClass("active"))$("#shareOverlay").removeClass("active");else{if($("#shareOverlay").addClass("active"),"Worldwide"!=currentCountry){var a=currentCountry.split(".");a=a[1]}else var a="Worldwide";var b=current.val+"_"+formatBlank(a);b=encodeURIComponent(b),$("#twitterLink").attr("href","http://twitter.com/home?status=Look%20what%20I%20found%20on%20%40GED_Tweet%21%20http%3A%2F%2Fftavis.com/%23"+b),$("facebookLink").attr("href","https://www.facebook.com/sharer/sharer.php?s=100&amp;p[url]=http%3A%2F%2Fftavis.com/%23"+b+"&amp;p[title]=Look%20what%20I%20found%20on%20%40GED_Tweet%21&amp;p[images][0]=./assets/img/ipad_01_closeup.jpg&amp;p[summary]=The%20data%20visualisation%20tool%20ftavis%20lets%20you%20explore%20more%20than%20700%20free%20trade%20agreements%20over%20the%20last%2060%20years."),$("#googleLink").attr("href","https://plus.google.com/share?url=http%3A%2F%2Fftavis.com/%23"+b),$("#mailLink").attr("href","mailto:?subject=Trade%20Agreement%20Visualisation&body=Look%20what%20I%20have%20found%20on%20http%3A%2F%2Fftavis.com%2F%23"+b)}});